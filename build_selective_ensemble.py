import os
import shutil
import json
import pprint

sampling100 = {
    "1000": 94.7876318241953,
    "1001": 82.66304751175608,
    "1002": 92.0346713719811,
    "1003": 85.12760735671043,
    "1004": 72.56538513208426,
    "1005": 87.88800810784218,
    "1006": 91.72775002230196,
    "1007": 83.87296842478594,
    "1008": 84.26722828396235,
    "1009": 87.2575339846859,
    "1010": 81.22006049350534,
    "1011": 91.64329447098376,
    "1012": 92.15232049723274,
    "1013": 84.26966681940402,
    "1014": 91.45973388108715,
    "1015": 89.69969059423937,
    "1016": 82.9221464631728,
    "1017": 93.20635839266633,
    "1018": 90.20313518772753,
    "1019": 95.90331369301644,
    "1020": 93.92669200257183,
    "1021": 95.2890151349122,
    "1022": 97.02257384895529,
    "1023": 95.94086684487439,
    "1024": 87.60776578865003,
    "1025": 85.84520018457712,
    "1026": 84.52677966741027,
    "1027": 92.25743542360578,
    "1028": 94.63347688318947,
    "1029": 85.81741232841811,
    "1030": 89.66295384791752,
    "1031": 95.53629333030104,
    "1032": 95.1565510382104,
    "1033": 94.18071900391962,
    "1034": 93.4825769608985,
    "1035": 79.33969401343974,
    "1036": 95.24267054988553,
    "1037": 93.14514942754174,
    "1038": 86.35899056836729,
    "1039": 92.22609621834374,
    "1040": 95.05818309399936,
    "1041": 93.77230507235713,
    "1042": 89.88728391777107,
    "1043": 91.80017263177872,
    "1044": 89.64292177596968,
    "1045": 91.73749084793738,
    "1046": 83.52650801116201,
    "1047": 80.83669282716986,
    "1048": 86.74203712244386,
    "1049": 89.61270130660526,
    "1050": 91.75284988892508,
    "1051": 88.44905724169266,
    "1052": 96.84689781801957,
    "1053": 74.55899372727681,
    "1054": 94.35548766592895,
    "1055": 90.90644057044929,
    "1056": 92.67619437852565,
    "1057": 89.7073875641839,
    "1058": 91.7328506193534,
    "1059": 84.9982750312246,
    "1060": 90.94736020570224,
    "1061": 88.13400843691427,
    "1062": 91.97438764201466,
    "1063": 97.19172345991659,
    "1064": 92.27693000955944,
    "1065": 95.41437831505029,
    "1066": 67.97773277585321,
    "1067": 93.96676079184381,
    "1068": 93.28416379823668,
    "1069": 84.43770712970765,
    "1070": 97.0827250606625,
    "1071": 83.24182829487415,
    "1072": 90.88425088940102,
    "1073": 93.70622676757034,
    "1074": 95.92158591311463,
    "1075": 89.82221343641662,
    "1076": 95.91790905441857,
    "1077": 87.91214229520142,
    "1078": 85.45168357131898,
    "1079": 93.8997139769426,
    "1080": 90.58729383747104,
    "1081": 96.41263025750904,
    "1082": 97.14922941009324,
    "1083": 96.3236004285267,
    "1084": 84.4557167160049,
    "1085": 97.90517773117769,
    "1086": 95.7901280415364,
    "1087": 89.94977839999117,
    "1088": 89.40634292672115,
    "1089": 87.17515281832962,
    "1090": 94.42678796762432,
    "1091": 74.45155195641895,
    "1092": 90.9395472763743,
    "1093": 92.39211751131104,
    "1094": 92.37166219526131,
    "1095": 90.59548697074676,
    "1096": 87.10537490497987,
    "1097": 96.78032260396232,
    "1098": 93.0606695529202,
    "1099": 86.65879822064625,
    "1100": 93.35169442354814,
    "1101": 88.21020052487319,
    "1102": 70.34180373323197,
    "1103": 97.6257678363525,
    "1104": 89.24128804436242,
    "1105": 94.58540987293082,
    "1106": 91.80973629478454,
    "1107": 96.2539671685932,
    "1108": 97.39188349908423,
    "1109": 95.82443377530055,
    "1110": 71.79123443071732,
    "1111": 94.11562245131142,
    "1112": 90.49667382186274,
    "1113": 90.0314303050252,
    "1114": 96.12763512886075,
    "1115": 95.10327526891403,
    "1116": 94.79469218330502,
    "1117": 90.13914575558503,
    "1118": 82.38271909276216,
    "1119": 91.4113765255063,
    "1120": 91.2845763230869,
    "1121": 89.7546528598537,
    "1122": 96.14921769515097,
    "1123": 94.92058860126616,
    "1124": 94.7317389479353,
    "1125": 90.5824243494641,
    "1126": 87.10151987596343,
    "1127": 80.57900317527762,
    "1128": 94.84031971795831,
    "1129": 94.71283876722698,
    "1130": 96.65696313966119,
    "1131": 96.47235582770516,
    "1132": 91.43465694632222,
    "1133": 95.46012315399881,
    "1134": 96.4544095798024,
    "1135": 95.72840883585909,
    "1136": 89.96133748173317,
    "1137": 90.10589777969484,
    "1138": 96.51444448930849,
    "1139": 87.08870501806939,
    "1140": 88.58442742762757,
    "1141": 89.36341936522506,
    "1142": 86.3159442477393,
    "1143": 80.8446854640792,
    "1144": 97.28122459582951,
    "1145": 90.76232675927623,
    "1146": 91.59433226462129,
    "1147": 84.56272009064536,
    "1148": 94.65218668020651,
    "1149": 95.54769795959099,
    "1150": 97.1521856100232,
    "1151": 89.69893269237282,
    "1152": 94.12177546168738,
    "1153": 93.65544034251491,
    "1154": 90.89996532682278,
    "1155": 90.4213900855473,
    "1156": 94.87608255621257,
    "1157": 71.81930393551981,
    "1158": 90.13508643788386,
    "1159": 96.2971752270023,
    "1160": 89.79273593946633,
    "1161": 94.95004152927694,
    "1162": 96.9476716878884,
    "1163": 93.65699583799142,
    "1164": 93.13684958029701,
    "1165": 93.6561823794595,
    "1166": 92.8878131095428,
    "1167": 92.71573194592018,
    "1168": 72.94357052072219,
    "1169": 95.9877219901802,
    "1170": 73.15829997194072,
    "1171": 84.89090853217499,
    "1172": 83.4078514863036,
    "1173": 91.11553838829636,
    "1174": 93.24150786909878,
    "1175": 93.7846176122006,
    "1176": 84.70739943060244,
    "1177": 96.98806728219901,
    "1178": 96.03341080007296,
    "1179": 91.14825936747096,
    "1180": 91.93765224391454,
    "1181": 94.38860954673929,
    "1182": 96.05280605653127,
    "1183": 70.9387184968208,
    "1184": 97.28503650765283,
    "1185": 92.71460861830441,
    "1186": 87.83325874290279,
    "1187": 90.89032663141609,
    "1188": 95.15907393881281,
    "1189": 94.91391412573277,
    "1190": 93.81803948830971,
    "1191": 96.89832273867034,
    "1192": 94.11267755078474,
    "1193": 97.80171561791747,
    "1194": 92.8637527614886,
    "1195": 93.93460955950823,
    "1196": 94.34150777567994,
    "1197": 94.56325530014175,
    "1198": 87.5661524515695,
    "1199": 94.16142431878403,
    "1200": 89.0022715186116,
    "1201": 84.48956062464832,
    "1202": 92.26665308904246,
    "1203": 91.43394011446085,
    "1204": 79.13370751243748,
    "1205": 97.15122434908479,
    "1206": 95.45668185699137,
    "1207": 94.15261629788182,
    "1208": 87.37850400671039,
    "1209": 93.22569578293027,
    "1210": 90.5153042044087,
    "1211": 97.54740485613421,
    "1212": 94.38305453606567,
    "1213": 94.46164602206127,
    "1214": 96.42358386910004,
    "1215": 86.57870335873646,
    "1216": 80.83819820896791,
    "1217": 91.08692332078587,
    "1218": 86.85681530420186
}

sampling500 = {
    "1000": 97.42087151978876,
    "1001": 93.48583494790144,
    "1002": 96.04223991905499,
    "1003": 92.19108469437886,
    "1004": 89.25248740173487,
    "1005": 91.80178697225793,
    "1006": 96.58334893577654,
    "1007": 94.35271026843552,
    "1008": 92.70973042715237,
    "1009": 92.88859002929362,
    "1010": 92.95883043192187,
    "1011": 95.87912280796169,
    "1012": 95.4775263587893,
    "1013": 91.8230394973461,
    "1014": 96.45322348717772,
    "1015": 96.31515659600474,
    "1016": 94.33041660578452,
    "1017": 96.66395645624985,
    "1018": 94.2096204301116,
    "1019": 97.66127334851117,
    "1020": 97.71190329079877,
    "1021": 97.1010015203592,
    "1022": 97.58951981502636,
    "1023": 98.19117306124035,
    "1024": 93.79133667956158,
    "1025": 92.83212977111907,
    "1026": 91.26553060736545,
    "1027": 95.66830447394747,
    "1028": 97.49857391483613,
    "1029": 94.57573734681222,
    "1030": 94.08772312706316,
    "1031": 97.2263043397687,
    "1032": 97.32249504311825,
    "1033": 96.21391865934514,
    "1034": 94.36341155289404,
    "1035": 89.63579532685819,
    "1036": 96.88918378920212,
    "1037": 96.60609974633594,
    "1038": 93.57274298518169,
    "1039": 95.48710175007999,
    "1040": 97.64508754382922,
    "1041": 97.24491679227089,
    "1042": 94.11133842760539,
    "1043": 96.71778540723732,
    "1044": 93.34855921714325,
    "1045": 95.78819123694475,
    "1046": 90.66217885100141,
    "1047": 92.91292366730464,
    "1048": 92.47249397174124,
    "1049": 93.30310712926592,
    "1050": 95.93431874435095,
    "1051": 93.62702403152191,
    "1052": 97.76067732071833,
    "1053": 81.60197550439727,
    "1054": 96.52481706895195,
    "1055": 95.97041736729588,
    "1056": 96.7923802514395,
    "1057": 95.1635435265278,
    "1058": 95.16001163611249,
    "1059": 89.34365055234859,
    "1060": 94.89347809809571,
    "1061": 92.60196338319855,
    "1062": 96.49628062688757,
    "1063": 97.81745887730338,
    "1064": 96.8161664153147,
    "1065": 96.87247251270855,
    "1066": 83.82052808194703,
    "1067": 97.07602373081858,
    "1068": 95.334688721145,
    "1069": 93.38038334088213,
    "1070": 98.34134439044693,
    "1071": 90.28543018944248,
    "1072": 94.80004176195828,
    "1073": 96.83911626821563,
    "1074": 97.37274771970976,
    "1075": 96.2810926377573,
    "1076": 97.06610675265088,
    "1077": 92.64751249333503,
    "1078": 90.7377685700173,
    "1079": 96.0371694560219,
    "1080": 95.24202272904779,
    "1081": 98.05454685761944,
    "1082": 98.22148277144535,
    "1083": 97.2695818460665,
    "1084": 89.68444799027264,
    "1085": 98.63320511632645,
    "1086": 97.58198302854078,
    "1087": 95.2381142582208,
    "1088": 93.37762224682417,
    "1089": 91.50366814606559,
    "1090": 96.58762963652053,
    "1091": 86.37953713170862,
    "1092": 96.36629070711602,
    "1093": 96.37043333236186,
    "1094": 97.07781447895775,
    "1095": 93.95073139557404,
    "1096": 95.98340366587779,
    "1097": 97.69253382530508,
    "1098": 96.40457164490257,
    "1099": 91.71062057398622,
    "1100": 96.54907237765133,
    "1101": 91.11406743613502,
    "1102": 84.77229922457866,
    "1103": 98.39814971190594,
    "1104": 94.7659901573938,
    "1105": 96.04282540145091,
    "1106": 96.40319871654987,
    "1107": 97.27588190945008,
    "1108": 98.67848774547541,
    "1109": 97.0489058332756,
    "1110": 86.75061121055698,
    "1111": 97.1475596094201,
    "1112": 95.69308527529755,
    "1113": 93.37084590175854,
    "1114": 97.43763387534032,
    "1115": 97.11469793762456,
    "1116": 97.4098888206567,
    "1117": 92.88754704892351,
    "1118": 90.18644347471316,
    "1119": 95.70989997104013,
    "1120": 95.44746552416463,
    "1121": 95.95595164410233,
    "1122": 97.83299340266905,
    "1123": 97.79087667134095,
    "1124": 97.67783931984309,
    "1125": 95.49202955761443,
    "1126": 93.33244602988356,
    "1127": 89.61136619125818,
    "1128": 97.51936013220188,
    "1129": 95.84735547014493,
    "1130": 97.89775068825007,
    "1131": 97.26394915678384,
    "1132": 94.90399046105321,
    "1133": 97.04571623521997,
    "1134": 97.92558286645092,
    "1135": 97.673967696412,
    "1136": 95.51166016479137,
    "1137": 93.72402966511277,
    "1138": 97.89528929063434,
    "1139": 94.95038749909168,
    "1140": 94.74137341729374,
    "1141": 95.36388949257794,
    "1142": 91.99597373654163,
    "1143": 91.81181142405653,
    "1144": 97.88015997170339,
    "1145": 95.77204473987344,
    "1146": 96.13375767976638,
    "1147": 94.71363348043296,
    "1148": 97.36071990400757,
    "1149": 96.85664408588305,
    "1150": 98.14452677570122,
    "1151": 93.64394464912175,
    "1152": 96.29535128837102,
    "1153": 96.24872166005035,
    "1154": 96.06892075992184,
    "1155": 95.12280438280274,
    "1156": 96.28565625826766,
    "1157": 81.57268221497682,
    "1158": 95.7325026666538,
    "1159": 96.93613059403626,
    "1160": 96.48362629010785,
    "1161": 97.04086565242451,
    "1162": 98.21919192928686,
    "1163": 96.40787856664537,
    "1164": 95.30436905409421,
    "1165": 96.3903840981571,
    "1166": 94.53712099084709,
    "1167": 95.3713656763431,
    "1168": 88.74031512865542,
    "1169": 97.3327868007999,
    "1170": 88.91474829983957,
    "1171": 89.42878925530847,
    "1172": 93.17084594499009,
    "1173": 94.39754615523209,
    "1174": 96.16291430419142,
    "1175": 96.62183411270048,
    "1176": 91.2968726929337,
    "1177": 98.06905988204126,
    "1178": 97.30065147357138,
    "1179": 95.03782728218087,
    "1180": 97.3180703636495,
    "1181": 96.13431956644172,
    "1182": 97.72339811882595,
    "1183": 85.13245307603192,
    "1184": 97.92959992810403,
    "1185": 96.4317948836842,
    "1186": 93.44669607916391,
    "1187": 95.72661862158525,
    "1188": 97.4082110154965,
    "1189": 96.88169872152827,
    "1190": 96.54574145433953,
    "1191": 98.17554060151406,
    "1192": 97.12158572310727,
    "1193": 98.2429067437903,
    "1194": 96.7207990335563,
    "1195": 96.41296304107573,
    "1196": 96.19519654054321,
    "1197": 96.29813271307484,
    "1198": 93.89009875835245,
    "1199": 95.98902041822147,
    "1200": 92.44197101175632,
    "1201": 93.7309474122023,
    "1202": 95.09179798404033,
    "1203": 95.4396751105735,
    "1204": 91.11775118358482,
    "1205": 98.24638898105334,
    "1206": 97.08609009632741,
    "1207": 95.55924936206922,
    "1208": 93.58090967270337,
    "1209": 96.09380534148458,
    "1210": 94.80719645307147,
    "1211": 98.15290408677994,
    "1212": 97.16934032288447,
    "1213": 97.50559076580298,
    "1214": 97.90575155802802,
    "1215": 94.02265624422975,
    "1216": 88.34953562188225,
    "1217": 97.74242027234222,
    "1218": 92.64625973329667
}


def main():
    in_test_scores_path = "selective_ensemble/test_scores/"
    out_test_images_path = "selective_ensemble/"
    sampling_rate_500 = (3.9175, 'S500')

    sampling_diff = {}
    for key in sampling100.keys():
        sampling_diff[key] = sampling500[key] - sampling100[key]


    scores_dicts = []
    for scores_file in os.listdir(in_test_scores_path):
        if os.path.isfile(os.path.join(in_test_scores_path, scores_file)):
            with open(os.path.join(in_test_scores_path, scores_file), 'r') as file:
                scores = json.load(file)
            if sampling_rate_500[1] in scores_file:
                for key in scores.keys():
                    scores[key] = scores[key] - sampling_diff[key]  # offset for new sampling rate
            scores_dicts.append((scores, scores_file))
    
    max_scores = []
    scores_gathered = {}
    used_preds = {}
    for key in scores_dicts[0][0].keys():
        max_score = (-1., "NoneKey", "NoneName")
        for scores_dict in scores_dicts:
            score = scores_dict[0][key]

            if key in scores_gathered.keys():
                scores_gathered[key].append((score, key, scores_dict[1][:-5]))
            else:
                scores_gathered[key] = [(score, key, scores_dict[1][:-5])]

            if score > max_score[0]:
                max_score = (score, key, scores_dict[1][:-5])
        max_scores.append(max_score)    
        if max_score[2] in used_preds.keys():
            used_preds[max_score[2]] = used_preds[max_score[2]] + 1
        else:
            used_preds[max_score[2]] = 1
        #print('max_score: ' + str(max_score))


    scores_gathered_list = []
    for key in scores_gathered.keys():
        # scores_gathered[key] = sorted(scores_gathered[key], reverse = True)
        scores_gathered_list.append(sorted(scores_gathered[key], reverse = True)[:3])
    scores_gathered_list = sorted(scores_gathered_list, reverse = True)
    for item in scores_gathered_list:
        out_string = '[' + str(item[0][1]) + '] '
        for item_tuple in item:
            out_string += '(' + str(round(item_tuple[0], 3)) + ', ' + str(item_tuple[2])+ '), '
        print(out_string)


    #for max_score in sorted(max_scores):
    #    print(max_score)
    pprint.pprint(used_preds)
    avg_score = sum(i for i, _, _ in max_scores) / len(max_scores)
    print('avg_score: ' + str(avg_score))
    

    # delete out dirs and recreate
    selected_images_path = os.path.join(out_test_images_path, 'selected_images')
    selected_images_details_path = os.path.join(out_test_images_path, 'selected_images_details')
    labels_details_images_path = os.path.join(out_test_images_path, 'labels_details')
    shutil.rmtree(selected_images_path, ignore_errors=True)
    shutil.rmtree(selected_images_details_path, ignore_errors=True)
    shutil.rmtree(labels_details_images_path, ignore_errors=True)
    if not os.path.isdir(selected_images_path):
        os.makedirs(selected_images_path)
    if not os.path.isdir(selected_images_details_path):
        os.makedirs(selected_images_details_path)
    if not os.path.isdir(labels_details_images_path):
        os.makedirs(labels_details_images_path)


    for max_score in max_scores:
        src_path = os.path.join('dataset/point/', max_score[2], max_score[1] + '_ip.png')
        src_labels_path = os.path.join('dataset/point/test_ml_comp_labels', max_score[1] + '_ip.png')
        dst_selected_path = os.path.join(out_test_images_path, 'selected_images')
        dst_selected_details_path = os.path.join(out_test_images_path, 'selected_images_details', str(round(max_score[0], 3)) + '_' + max_score[1]  + '_' + max_score[2] + '.png')
        dst_labels_details_path = os.path.join(out_test_images_path, 'labels_details', str(round(max_score[0], 3)) + '_' + max_score[1]  + '_' + max_score[2] + '.png')

        shutil.copy(src_path, dst_selected_path)
        shutil.copy(src_path, dst_selected_details_path)
        shutil.copy(src_labels_path, dst_labels_details_path)


if __name__ == '__main__':
    main()

